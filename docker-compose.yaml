# ========================================
# SERENIA - Docker Compose Production
# ========================================
# Full-stack deployment with Angular, Quarkus JVM, PostgreSQL, and Mailpit

services:
  # ========================================
  # DATABASE - PostgreSQL
  # ========================================
  postgres:
    image: postgres:16-alpine
    container_name: serenia-postgres
    restart: unless-stopped

    environment:
      POSTGRES_DB: ${POSTGRES_DB:-serenia}
      POSTGRES_USER: ${POSTGRES_USER:-serenia}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-serenia}
      PGDATA: /var/lib/postgresql/data/pgdata

    volumes:
      - serenia_postgres_data:/var/lib/postgresql/data

    networks:
      - serenia-internal

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d ${POSTGRES_DB:-serenia} -U ${POSTGRES_USER:-serenia}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    # Security: Don't expose database port in production
    # Uncomment for debugging only:
    # ports:
    #   - "5432:5432"

    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # ========================================
  # SMTP SERVER - Mailpit
  # ========================================
  mailpit:
    image: axllent/mailpit:latest
    container_name: serenia-mailpit
    restart: unless-stopped

    environment:
      MP_SMTP_AUTH_ACCEPT_ANY: 1
      MP_SMTP_AUTH_ALLOW_INSECURE: 1
      MP_MAX_MESSAGES: 5000
      MP_DATABASE: /data/mailpit.db

    volumes:
      - serenia_mailpit_data:/data

    networks:
      - serenia-internal

    ports:
      - "${MAILPIT_WEB_PORT:-8025}:8025"

    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8025/api/v1/info"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M

  # ========================================
  # BACKEND - Quarkus JVM
  # ========================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.jvm
    image: serenia-backend:${APP_VERSION:-latest}
    container_name: serenia-backend
    restart: unless-stopped

    depends_on:
      postgres:
        condition: service_healthy
      mailpit:
        condition: service_healthy

    environment:
      # Application
      QUARKUS_HTTP_PORT: ${QUARKUS_HTTP_PORT:-8080}

      # Database
      QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://postgres:5432/${POSTGRES_DB:-serenia}
      QUARKUS_DATASOURCE_USERNAME: ${QUARKUS_DATASOURCE_USERNAME:-serenia}
      QUARKUS_DATASOURCE_PASSWORD: ${QUARKUS_DATASOURCE_PASSWORD:-serenia}

      # CORS
      CORS_ENABLED: ${CORS_ENABLED:-true}
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:80}
      CORS_METHODS: ${CORS_METHODS:-GET,POST,PUT,DELETE,OPTIONS}
      CORS_ACCESS_CONTROL_ALLOW_CREDENTIALS: ${CORS_ACCESS_CONTROL_ALLOW_CREDENTIALS:-true}
      CORS_ACCESS_CONTROL_ALLOW_HEADERS: ${CORS_ACCESS_CONTROL_ALLOW_HEADERS:-Content-Type,Authorization,X-Requested-With,Origin,Accept}
      CORS_ACCESS_CONTROL_EXPOSE_HEADERS: ${CORS_ACCESS_CONTROL_EXPOSE_HEADERS:-Authorization}

      # JWT Security
      MP_JWT_VERIFY_PUBLICKEY_LOCATION: file:/keys/publicKey.pem
      MP_JWT_VERIFY_ISSUER: ${SERENIA_AUTH_JWT_ISSUER:-serenia}
      MP_JWT_TOKEN_HEADER: Authorization
      SMALLRYE_JWT_SIGN_KEY_LOCATION: file:/keys/privateKey.pem
      SMALLRYE_JWT_SIGN_KEY_ID: ${JWT_KEY_ID:-1}

      # Authentication
      SERENIA_AUTH_JWT_ISSUER: ${SERENIA_AUTH_JWT_ISSUER:-serenia}
      SERENIA_AUTH_EXPIRATION_TIME: ${SERENIA_AUTH_EXPIRATION_TIME:-3600}
      SERENIA_AUTH_MAX_USERS: ${SERENIA_AUTH_MAX_USERS:-200}

      # Token Quotas
      SERENIA_TOKENS_INPUT_LIMIT_DEFAULT: ${SERENIA_TOKENS_INPUT_LIMIT_DEFAULT:-100000}
      SERENIA_TOKENS_OUTPUT_LIMIT_DEFAULT: ${SERENIA_TOKENS_OUTPUT_LIMIT_DEFAULT:-100000}
      SERENIA_TOKENS_TOTAL_LIMIT_DEFAULT: ${SERENIA_TOKENS_TOTAL_LIMIT_DEFAULT:-200000}

      # Email Configuration
      QUARKUS_MAILER_FROM: ${QUARKUS_MAILER_FROM:-noreply@serenia.local}
      QUARKUS_MAILER_HOST: mailpit
      QUARKUS_MAILER_PORT: 1025
      QUARKUS_MAILER_SSL: "false"
      QUARKUS_MAILER_START_TLS: DISABLED

      # Email Verification
      SERENIA_EMAIL_VERIFICATION_TOKEN_EXPIRATION_MINUTES: ${SERENIA_EMAIL_VERIFICATION_TOKEN_EXPIRATION_MINUTES:-1440}

      # Security
      SERENIA_SECURITY_KEY: ${SERENIA_SECURITY_KEY}

      # OpenAI
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o-mini}

      # URLs
      SERENIA_URL: ${SERENIA_URL:-http://localhost:8080}
      SERENIA_FRONT_URL: ${SERENIA_FRONT_URL:-http://localhost:4200}

      # System Prompt
      SERENIA_SYSTEM_PROMPT: ${SERENIA_SYSTEM_PROMPT:-You are Serenia, a helpful AI assistant.}

      # Logging
      QUARKUS_LOG_LEVEL: ${QUARKUS_LOG_LEVEL:-INFO}

    volumes:
      - ./keys:/keys:ro

    networks:
      - serenia-internal

    # Internal only - accessed via frontend nginx proxy
    expose:
      - "8080"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/q/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

    deploy:
      resources:
        limits:
          memory: 768M
        reservations:
          memory: 512M

  # ========================================
  # FRONTEND - Angular + Nginx
  # ========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    image: serenia-frontend:${APP_VERSION:-latest}
    container_name: serenia-frontend
    restart: unless-stopped

    depends_on:
      backend:
        condition: service_healthy

    networks:
      - serenia-internal
      - serenia-external

    ports:
      - "${FRONTEND_PORT:-80}:80"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M

# ========================================
# NETWORKS
# ========================================
networks:
  serenia-internal:
    driver: bridge
    internal: true

  serenia-external:
    driver: bridge

# ========================================
# VOLUMES
# ========================================
volumes:
  serenia_postgres_data:
    driver: local
  serenia_mailpit_data:
    driver: local
