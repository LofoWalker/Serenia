# ========================================
# SERENIA - Docker Compose Production (Corrigé)
# ========================================

services:
  # ========================================
  # PostgreSQL Database
  # ========================================
  postgres:
    image: postgres:16-alpine
    container_name: serenia-postgres
    restart: unless-stopped

    environment:
      POSTGRES_DB: ${POSTGRES_DB:-serenia}
      POSTGRES_USER: ${QUARKUS_DATASOURCE_USERNAME:-serenia}
      POSTGRES_PASSWORD: ${QUARKUS_DATASOURCE_PASSWORD:?POSTGRES_PASSWORD is required}
      PGDATA: /var/lib/postgresql/data/pgdata

    volumes:
      - serenia_postgres_data:/var/lib/postgresql/data

    networks:
      - serenia-internal

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d ${POSTGRES_DB:-serenia} -U ${QUARKUS_DATASOURCE_USERNAME:-serenia}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ========================================
  # Quarkus Backend (Native)
  # ========================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.native
    image: serenia/backend:${APP_VERSION:-latest}
    container_name: serenia-backend
    restart: unless-stopped

    depends_on:
      postgres:
        condition: service_healthy

    environment:
      # Database
      QUARKUS_DATASOURCE_JDBC_URL: ${QUARKUS_DATASOURCE_JDBC_URL:-jdbc:postgresql://postgres:5432/serenia}
      QUARKUS_DATASOURCE_USERNAME: ${QUARKUS_DATASOURCE_USERNAME:-serenia}
      QUARKUS_DATASOURCE_PASSWORD: ${QUARKUS_DATASOURCE_PASSWORD:?QUARKUS_DATASOURCE_PASSWORD is required}

      # HTTP & CORS
      QUARKUS_HTTP_PORT: ${QUARKUS_HTTP_PORT:-8087}
      QUARKUS_HTTP_HOST: 0.0.0.0
      CORS_ENABLED: ${CORS_ENABLED:-true}
      CORS_METHODS: ${CORS_METHODS:-GET,POST,PUT,DELETE,OPTIONS}
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:80}
      CORS_ACCESS_CONTROL_ALLOW_CREDENTIALS: ${CORS_ACCESS_CONTROL_ALLOW_CREDENTIALS:-true}
      CORS_ACCESS_CONTROL_ALLOW_HEADERS: ${CORS_ACCESS_CONTROL_ALLOW_HEADERS:-Content-Type,Authorization,X-Requested-With,Origin,Accept}
      CORS_ACCESS_CONTROL_EXPOSE_HEADERS: ${CORS_ACCESS_CONTROL_EXPOSE_HEADERS:-Authorization}

      # JWT Security
      MP_JWT_VERIFY_PUBLICKEY_LOCATION: ${MP_JWT_VERIFY_PUBLICKEY_LOCATION:-/work/keys/publicKey.pem}
      MP_JWT_VERIFY_ISSUER: ${MP_JWT_VERIFY_ISSUER:-serenia}
      MP_JWT_TOKEN_HEADER: ${MP_JWT_TOKEN_HEADER:-Authorization}
      SMALLRYE_JWT_SIGN_KEY_LOCATION: ${SMALLRYE_JWT_SIGN_KEY_LOCATION:-/work/keys/privateKey.pem}
      SMALLRYE_JWT_SIGN_KEY_ID: ${SMALLRYE_JWT_SIGN_KEY_ID:-1}

      # Authentication
      SERENIA_AUTH_JWT_ISSUER: ${SERENIA_AUTH_JWT_ISSUER:-serenia}
      SERENIA_AUTH_EXPIRATION_TIME: ${SERENIA_AUTH_EXPIRATION_TIME:-3600}
      SERENIA_AUTH_MAX_USERS: ${SERENIA_AUTH_MAX_USERS:-200}

      # Token Quotas
      SERENIA_TOKENS_INPUT_LIMIT_DEFAULT: ${SERENIA_TOKENS_INPUT_LIMIT_DEFAULT:-100000}
      SERENIA_TOKENS_OUTPUT_LIMIT_DEFAULT: ${SERENIA_TOKENS_OUTPUT_LIMIT_DEFAULT:-100000}
      SERENIA_TOKENS_TOTAL_LIMIT_DEFAULT: ${SERENIA_TOKENS_TOTAL_LIMIT_DEFAULT:-200000}

      # Email Configuration
      QUARKUS_MAILER_FROM: ${QUARKUS_MAILER_FROM:?QUARKUS_MAILER_FROM is required}
      QUARKUS_MAILER_HOST: ${QUARKUS_MAILER_HOST:?QUARKUS_MAILER_HOST is required}
      QUARKUS_MAILER_PORT: ${QUARKUS_MAILER_PORT:-587}
      QUARKUS_MAILER_USERNAME: ${QUARKUS_MAILER_USERNAME:?QUARKUS_MAILER_USERNAME is required}
      QUARKUS_MAILER_PASSWORD: ${QUARKUS_MAILER_PASSWORD:?QUARKUS_MAILER_PASSWORD is required}
      QUARKUS_MAILER_SSL: ${QUARKUS_MAILER_SSL:-false}
      QUARKUS_MAILER_START_TLS: ${QUARKUS_MAILER_START_TLS:-REQUIRED}
      SERENIA_EMAIL_VERIFICATION_TOKEN_EXPIRATION_MINUTES: ${SERENIA_EMAIL_VERIFICATION_TOKEN_EXPIRATION_MINUTES:-1440}

      # Security
      SERENIA_SECURITY_KEY: ${SERENIA_SECURITY_KEY:?SERENIA_SECURITY_KEY is required}

      # OpenAI Integration
      OPENAI_API_KEY: ${OPENAI_API_KEY:?OPENAI_API_KEY is required}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o-mini}

      # URLs
      SERENIA_URL: ${SERENIA_URL:-http://localhost:8080}
      SERENIA_FRONT_URL: ${SERENIA_FRONT_URL:-http://localhost:80}

      # Logging
      QUARKUS_LOG_LEVEL: ${QUARKUS_LOG_LEVEL:-INFO}
      SERENIA_LOG_LEVEL: ${SERENIA_LOG_LEVEL:-INFO}

      # System Prompt
      SERENIA_SYSTEM_PROMPT: ${SERENIA_SYSTEM_PROMPT:-"Tu es Serenia, une présence chaleureuse et empathique."}

    volumes:
      - ./keys:/work/keys:ro

    networks:
      - serenia-internal
      - serenia-external

    # Exposer le port si vous voulez accéder directement au backend (optionnel)
    ports:
      - "${BACKEND_PORT:-8087}:8087"

  # ========================================
  # Angular Frontend (Nginx)
  # ========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        API_URL: ${SERENIA_URL:-http://localhost:8087}
    image: serenia/frontend:${APP_VERSION:-latest}
    container_name: serenia-frontend
    restart: unless-stopped

    depends_on:
      backend:
        condition: service_healthy

    ports:
      - "${FRONTEND_PORT:-80}:8080"
