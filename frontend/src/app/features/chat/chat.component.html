<div class="h-[calc(100vh-4rem)] flex flex-col bg-primary-950">
  <div
    #messagesContainer
    class="flex-1 overflow-y-auto py-6 scrollbar-thin"
    (scroll)="onScroll()"
  >
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      @if (!chatService.hasMessages()) {
        <div class="flex flex-col items-center justify-center h-full min-h-[50vh] text-center">
          <div class="w-16 h-16 mb-6 rounded-full bg-primary-800 flex items-center justify-center">
            <svg class="w-8 h-8 text-primary-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
          </div>
          <h2 class="text-xl font-semibold text-primary-100 mb-2">
            Bienvenue, {{ authState.userFullName() }}
          </h2>
          <p class="text-primary-400 max-w-md">
            Commencez une conversation avec Serenia. Posez vos questions ou partagez vos pensées.
          </p>
        </div>
      } @else {
        <div role="log" aria-live="polite" aria-label="Messages de la conversation">
          @if (chatService.hasMoreMessages()) {
            <div class="flex justify-center mb-4">
              <button
                type="button"
                (click)="loadMore()"
                [disabled]="chatService.loadingMore()"
                class="px-4 py-2 text-sm font-medium text-primary-400 hover:text-primary-200 bg-primary-800/50 hover:bg-primary-800 rounded-lg transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-400 disabled:opacity-50"
              >
                @if (chatService.loadingMore()) {
                  <span class="flex items-center gap-2">
                    <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Chargement...
                  </span>
                } @else {
                  Charger les messages précédents ({{ chatService.totalMessages() - chatService.messages().length }} restants)
                }
              </button>
            </div>
          }

          @for (message of chatService.messages(); track $index) {
            <app-chat-message [message]="message" />
          }

          @if (chatService.loading()) {
            <div class="flex justify-start mb-4">
              <div class="bg-primary-800 border border-primary-700 px-4 py-3 rounded-2xl rounded-bl-md">
                <div class="flex items-center gap-1" aria-label="Serenia est en train de répondre">
                  <span class="w-2 h-2 bg-primary-400 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
                  <span class="w-2 h-2 bg-primary-400 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
                  <span class="w-2 h-2 bg-primary-400 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
                </div>
              </div>
            </div>
          }
        </div>
      }

      @if (errorMessage()) {
        <div class="mt-4">
          <app-alert type="error" [message]="errorMessage()" />
          @if (quotaError()) {
            <div class="mt-3 flex justify-center">
              <app-button
                variant="primary"
                size="sm"
                (clicked)="goToProfile()"
              >
                Changer de plan
              </app-button>
            </div>
          }
        </div>
      }
    </div>
  </div>

  <div class="border-t border-primary-800 bg-primary-900/50 backdrop-blur-sm p-4">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Indicateur de messages restants (seulement si < 20) -->
      @if (subscriptionService.status(); as status) {
        @if (status.messagesRemainingToday < 20) {
          <div class="text-xs text-center mb-2"
               [class.text-primary-500]="status.messagesRemainingToday > 2"
               [class.text-yellow-500]="status.messagesRemainingToday <= 2 && status.messagesRemainingToday > 0"
               [class.text-red-400]="status.messagesRemainingToday === 0">
            @if (status.messagesRemainingToday === 0) {
              <span>Aucun message restant aujourd'hui - <a routerLink="/profile" class="underline hover:text-red-300">Changer de plan</a></span>
            } @else {
              <span>{{ status.messagesRemainingToday }} message{{ status.messagesRemainingToday > 1 ? 's' : '' }} restant{{ status.messagesRemainingToday > 1 ? 's' : '' }} aujourd'hui</span>
            }
          </div>
        }
      }
      <app-chat-input
        #chatInput
        (messageSent)="onSendMessage($event)"
      />
    </div>
  </div>
</div>

